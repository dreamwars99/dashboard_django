{% extends 'ui/base.html' %}
{% load static %}

{% block title %}KB 개인 여신 심사 대시보드{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'corporate/styles_cor.css' %}">
  <link rel="stylesheet" href="{% static 'personal/styles.css' %}">
{% endblock %}

{% block head_scripts %}
  <script src="{% static 'personal/index.js' %}" defer></script>
{% endblock %}

{% block header %}
  <div class="kb-header__titles">
    <h1 class="kb-header__title">AI 기반 개인 여신 심사 대시보드</h1>
    <p class="kb-header__subtitle">승인 여부·추천 한도·리스크 근거를 한 화면에서</p>
  </div>
{% endblock %}

{% block left_panel %}
  <div class="kb-card-stack">
    <section class="kb-card card input-panel" role="complementary" aria-labelledby="personalFormTitle">
      <h2 class="card__title card-title" id="personalFormTitle"><span class="card-title-icon">📝</span>고객 정보 입력</h2>
      <form id="loanForm" class="kb-form" aria-describedby="form-help">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="income">연 소득 (₩, 단위: 천원)</label>
            <input id="income" name="income" type="number" inputmode="numeric" step="1" class="form-input" placeholder="72000" />
          </div>
          <div class="form-group">
            <label class="form-label" for="amount">대출 희망액 (₩, 단위: 천원)</label>
            <input id="amount" name="amount" type="number" inputmode="numeric" step="1" class="form-input" placeholder="35000" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="credit">신용 점수</label>
            <input id="credit" name="credit" type="number" class="form-input" placeholder="561" />
          </div>
          <div class="form-group">
            <label class="form-label" for="rate">적용 이자율 (%)</label>
            <input id="rate" name="rate" type="number" step="0.01" class="form-input" placeholder="16.02" />
          </div>
        </div>
        <hr class="hr-light" aria-hidden="true" />
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="age">나이</label>
            <input id="age" name="age" type="number" class="form-input" placeholder="22" />
          </div>
          <div class="form-group">
            <label class="form-label" for="emp_years">직장 경력 (년)</label>
            <input id="emp_years" name="emp_years" type="number" class="form-input" placeholder="0" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="credit_hist">신용 기록 기간 (년)</label>
          <input id="credit_hist" name="credit_hist" type="number" class="form-input" placeholder="3" />
        </div>
        <div class="form-group">
          <label class="form-label" for="home">주거 형태</label>
          <select id="home" name="home" class="form-select">
            <option value="RENT">월세 (RENT)</option>
            <option value="OWN">자가 (OWN)</option>
            <option value="JEONSE">전세 (JEONSE)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="intent">대출 목적</label>
          <select id="intent" name="intent" class="form-select">
            <option value="PERSONAL">개인 용도 (PERSONAL)</option>
            <option value="BUSINESS">사업 (BUSINESS)</option>
            <option value="MORTGAGE">주택담보 (MORTGAGE)</option>
            <option value="AUTO">자동차 (AUTO)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" for="education">최종 학력</label>
          <select id="education" name="education" class="form-select">
            <option value="Master">석사 (Master)</option>
            <option value="Bachelor">학사 (Bachelor)</option>
            <option value="HighSchool">고졸 (High School)</option>
            <option value="PhD">박사 (PhD)</option>
          </select>
        </div>
        <fieldset class="form-fieldset">
          <legend class="form-legend">성별</legend>
          <div class="radio-row">
            <input type="radio" id="gender_female" name="gender" value="female" checked>
            <label for="gender_female">여성</label>
            <input type="radio" id="gender_male" name="gender" value="male" style="margin-left:16px;">
            <label for="gender_male">남성</label>
          </div>
        </fieldset>
        <fieldset class="form-fieldset">
          <legend class="form-legend">과거 연체 기록</legend>
          <div class="radio-stack">
            <input type="radio" id="default_no" name="default_hist" value="No" checked>
            <label for="default_no">없음 (No)</label>
            <br>
            <input type="radio" id="default_yes" name="default_hist" value="Yes">
            <label for="default_yes">있음 (Yes)</label>
          </div>
        </fieldset>
        <button type="button" class="submit-button kb-btn kb-btn--primary" aria-label="AI 심사 실행">💡 심사 실행</button>
        <p id="form-help" class="kb-form__help">* 필수값/포맷 검증은 JS에서 처리 예정</p>
      </form>
    </section>
  </div>
{% endblock %}

{% block main %}
  <section class="kb-summary" aria-labelledby="summaryTitle">
    <div class="kb-summary__gauge">
      <header class="kb-summary__header">
        <h2 class="kb-summary__title" id="summaryTitle">개인 심사 요약</h2>
        <span class="kb-summary__hint">승인확률(p̂) — 높을수록 승인 가능성 ↑</span>
      </header>
      <div class="chart-frame chart-frame--gauge">
        <div id="gaugeChart" class="kb-chart" role="img" aria-label="승인확률 게이지 차트"></div>
      </div>
      <div class="kb-threshold-row">
        <span class="summary-note" id="thetaText">임계값 θ = 0.42</span>
        <div class="kb-threshold-controls">
          <button type="button" id="thetaEditBtn" class="kb-btn kb-btn--ghost kb-btn--xs" aria-describedby="thetaTip">θ 조정</button>
          <span id="thetaTip" role="tooltip" class="kb-tooltip">임계값 θ는 승인/거절 컷라인. 높이면 보수적, 낮추면 적극적.</span>
          <div id="thetaPopover" class="kb-popover" hidden>
            <label for="thetaRange" class="kb-popover__label">임계값 θ 조정</label>
            <input id="thetaRange" type="range" min="0" max="1" step="0.01" value="0.42" class="kb-popover__range" />
            <div class="kb-popover__val">
              <output id="thetaOut">0.42</output>
            </div>
            <div class="kb-popover__row">
              <button type="button" id="thetaApply" class="kb-btn kb-btn--primary">적용</button>
              <button type="button" id="thetaCancel" class="kb-btn kb-btn--ghost">취소</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="kb-summary__metrics">
      <div class="kb-summary__metrics-grid">
        <div class="kb-summary__grade">
          <span class="kb-summary__grade-label">신용 등급</span>
          <div class="grade-badge grade--unknown" id="gradeBadge">--</div>
          <span class="decision-pill decision-pill--hold" id="decisionText">신중 검토</span>
        </div>
        <div class="kb-metric">
          <span class="kb-metric__label">요청 금액</span>
          <strong class="kb-metric__value" id="reqLimit">-</strong>
        </div>
        <div class="kb-metric">
          <span class="kb-metric__label">AI 추천 한도</span>
          <strong class="kb-metric__value kb-metric__value--accent" id="recLimit">-</strong>
        </div>
      </div>
      <div class="kb-progress" aria-label="요청 대 추천 한도 비율">
        <div class="kb-progress__bar" id="summaryProgressBar" style="width: 0%;" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
      </div>
      <p class="summary-note">요청 금액 대비 권고 한도를 비교해 승인 가능성을 확인하세요.</p>
    </div>

    <div class="kb-summary__risk" aria-labelledby="riskSummaryTitle">
      <header class="kb-summary__header">
        <h3 class="kb-summary__subtitle" id="riskSummaryTitle">위험도 분석</h3>
      </header>
      <div class="chart-frame chart-frame--square summary-risk">
        <div id="summaryRiskRadar" class="kb-chart" role="img" aria-label="위험도 분석 레이더 차트"></div>
      </div>
    </div>

    <div class="kb-summary__whatif" id="whatIfPanel">
      <div class="kb-summary__whatif-header">
        <h3 class="kb-summary__whatif-title">What-if 시뮬레이터</h3>
        <span class="hint">슬라이더 조정 시 0.25초 후 자동 반영</span>
      </div>
      <div class="whatif-controls">
        <div class="whatif-row">
          <div class="whatif-row__header">
            <label for="wiRate">금리(연 %)</label>
            <span class="delta-chip" id="wiRateOut">—</span>
          </div>
          <input id="wiRate" type="range" min="1" max="20" step="0.1" aria-describedby="wiRateOut" />
        </div>
        <div class="whatif-row">
          <div class="whatif-row__header">
            <label for="wiTerm">상환기간(개월)</label>
            <span class="delta-chip" id="wiTermOut">—</span>
          </div>
          <input id="wiTerm" type="range" min="12" max="120" step="12" aria-describedby="wiTermOut" />
        </div>
        <div class="whatif-row">
          <div class="whatif-row__header">
            <label for="wiAmount">요청액 (₩, 단위: 천원)</label>
            <span class="delta-chip" id="wiAmountOut">—</span>
          </div>
          <input id="wiAmount" type="range" min="1000000" max="100000000" step="500000" aria-describedby="wiAmountOut" />
        </div>
        <div class="whatif-row">
          <div class="whatif-row__header">
            <label for="wiIncome">연 소득 (₩, 단위: 천원)</label>
            <span class="delta-chip" id="wiIncomeOut">—</span>
          </div>
          <input id="wiIncome" type="range" min="12000000" max="240000000" step="1000000" aria-describedby="wiIncomeOut" />
        </div>
      </div>
      <div class="whatif-summary">
        <span class="whatif-pill">예상 승인확률 p̂: <strong id="wiPHat">—</strong></span>
        <span class="whatif-pill whatif-pill--wide">
          <span>요청 대비 권고 한도</span>
          <div class="kb-progress kb-progress--slim" aria-label="What-if 요청 대 권고 한도 비율">
            <div class="kb-progress__bar" id="wiProgress" style="width: 0%;" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
          </div>
        </span>
      </div>
    </div>
  </section>

  <section class="kb-grid-row kb-grid-row--two">
    <article class="kb-card card">
      <h3 class="card__title">🚦 리스크 매트릭스</h3>
      <div class="chart-frame chart-frame--square">
        <div id="riskHeatmap" class="kb-chart" role="img" aria-label="리스크 히트맵"></div>
      </div>
      <div class="kb-badge-row" aria-hidden="true">
        <span class="kb-badge kb-badge--low">신용 낮음</span>
        <span class="kb-badge kb-badge--mid">소득 중간</span>
        <span class="kb-badge kb-badge--high">부채 높음</span>
      </div>
    </article>
    <article class="kb-card card">
      <h3 class="card__title">📝 정책 알림 & 메모</h3>
      <div class="kb-memo">
        <div class="kb-memo__item">
          <strong class="kb-memo__label">2025-09-14</strong>
          <p class="kb-memo__text">신용 점수 700 미만 신청자에 대한 추가 소득 증빙 요청 기준이 변경되었습니다. 최신 공지 참고 바랍니다.</p>
        </div>
        <div class="kb-memo__item">
          <strong class="kb-memo__label">2025-09-10</strong>
          <p class="kb-memo__text">DSR 40% 초과 건은 리스크 심사팀에 자동 전달됩니다. 처리 SLA 4시간을 유지하세요.</p>
        </div>
        <div class="kb-memo__item">
          <strong class="kb-memo__label">2025-09-06</strong>
          <p class="kb-memo__text">금주 심사 모델 버전이 1.3.2로 업데이트되었습니다. 탐색형 분석에서 발생하는 차이를 주의 깊게 살펴보세요.</p>
        </div>
      </div>
    </article>
  </section>

  <section class="kb-grid-row kb-grid-row--single">
    <article class="kb-card card">
      <h3 class="card__title">🌊 결정 기여도</h3>
      <div class="chart-frame chart-frame--wide">
        <div id="shapChart" class="kb-chart" role="img" aria-label="SHAP 막대 차트"></div>
      </div>
    </article>
  </section>

  <section class="kb-grid-row kb-grid-row--single">
    <article class="kb-card card">
      <h3 class="card__title">⚖️ 정책 갭 보드</h3>
      <div class="chart-frame chart-frame--wide">
        <div id="policyGap" class="kb-chart" role="img" aria-label="정책 갭 보드"></div>
      </div>
    </article>
  </section>

  <section class="kb-grid-row kb-grid-row--single">
    <article class="kb-card card">
      <h3 class="card__title">📈 최근 승인율 추이 & 통계</h3>
      <div class="chart-frame chart-frame--wide">
        <div id="trendLine" class="kb-chart" role="img" aria-label="승인율 추이 차트"></div>
      </div>
      <div class="kb-trend-summary">
        <div class="kb-trend-summary__item">
          <span class="kb-trend-summary__label">최근 7일 승인율</span>
          <strong class="kb-trend-summary__value" id="trendApproveRate">74%</strong>
        </div>
        <div class="kb-trend-summary__item">
          <span class="kb-trend-summary__label">평균 심사 소요</span>
          <strong class="kb-trend-summary__value" id="trendAvgTime">3.2h</strong>
        </div>
        <div class="kb-trend-summary__item">
          <span class="kb-trend-summary__label">인입 건수</span>
          <strong class="kb-trend-summary__value" id="trendInbound">182건</strong>
        </div>
      </div>
    </article>
  </section>
{% endblock %}

{% block right_panel %}
  {% include 'ui/right_panel.html' with panel=panel %}
{% endblock %}
